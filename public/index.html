<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noteso - Administration</title>
    <style>
        :root {
            --bg-primary: #0f0f0f;
            --bg-secondary: #1a1a1a;
            --bg-tertiary: #252525;
            --bg-card: #1e1e1e;
            --border: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --text-muted: #666666;
            --accent-blue: #3b82f6;
            --accent-purple: #8b5cf6;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .app { display: flex; min-height: 100vh; }
        .sidebar {
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
        .sidebar-logo { font-size: 24px; font-weight: 700; }
        .nav-links { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
        .nav-link {
            display: flex; align-items: center; gap: 12px; padding: 12px 16px;
            color: var(--text-secondary); text-decoration: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; transition: all 0.2s; cursor: pointer;
        }
        .nav-link:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        .nav-link.active { background: var(--accent-blue); color: white; }
        .nav-icon { font-size: 18px; }
        .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
        .user-info { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; }
        .user-avatar { width: 36px; height: 36px; background: var(--accent-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .user-name { font-size: 13px; font-weight: 500; }
        .user-email { font-size: 11px; color: var(--text-muted); }
        .main { flex: 1; margin-left: 260px; padding: 24px; }
        #content { max-width: 1400px; margin: 0 auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 28px; font-weight: 700; }
        .page-subtitle { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        .header-actions { display: flex; gap: 8px; }
        .btn { padding: 10px 18px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--bg-card); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input, .form-select { width: 100%; padding: 10px 14px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--accent-blue); }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        .data-table td { font-size: 13px; }
        .data-table tr:hover { background: var(--bg-secondary); }
        .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 600; background: var(--bg-tertiary); }
        .badge.success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge.danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge.warning { background: rgba(234, 179, 8, 0.15); color: var(--warning); }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 500px; max-height: 90vh; overflow: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 1px solid var(--border); }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
        .modal-body { padding: 20px; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 16px 20px; border-top: 1px solid var(--border); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent-blue); border-radius: 50%; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .empty-state.small { padding: 20px; }
        .empty-state.small p { margin: 0 0 8px 0; font-size: 13px; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 14px 20px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--accent-blue); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .text-muted { color: var(--text-muted); }
        code { font-family: 'Monaco', 'Menlo', monospace; font-size: 12px; background: var(--bg-tertiary); padding: 2px 6px; border-radius: 4px; }
        /* Security Module */
        .security-tabs { display: flex; gap: 4px; background: var(--bg-secondary); padding: 4px; border-radius: 12px; margin-bottom: 24px; overflow-x: auto; }
        .security-tab { padding: 10px 16px; background: transparent; border: none; border-radius: 8px; color: var(--text-secondary); cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; transition: all 0.2s; }
        .security-tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .security-tab.active { background: var(--bg-card); color: var(--text-primary); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .security-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .security-stats .stat-card { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .security-stats .stat-card.danger { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); }
        .security-stats .stat-card.warning { border-color: var(--warning); background: rgba(234, 179, 8, 0.1); }
        .security-stats .stat-icon { font-size: 24px; }
        .security-stats .stat-value { font-size: 24px; font-weight: 700; }
        .security-stats .stat-label { font-size: 12px; color: var(--text-muted); }
        .security-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .security-grid .security-panel.wide { grid-column: span 2; }
        @media (max-width: 900px) { .security-grid { grid-template-columns: 1fr; } .security-grid .security-panel.wide { grid-column: span 1; } }
        .security-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .security-panel .panel-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .security-panel .panel-header h3 { font-size: 14px; font-weight: 600; margin: 0; }
        .security-panel .panel-link { font-size: 12px; color: var(--accent-blue); text-decoration: none; }
        .security-panel .panel-content { padding: 16px 20px; }
        .alert-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 8px; }
        .alert-item:last-child { margin-bottom: 0; }
        .alert-item.critical { background: rgba(239, 68, 68, 0.1); border-left: 3px solid var(--danger); }
        .alert-item.warning { background: rgba(234, 179, 8, 0.1); border-left: 3px solid var(--warning); }
        .alert-item .alert-icon { font-size: 16px; }
        .alert-item .alert-info { flex: 1; }
        .alert-item .alert-title { font-size: 13px; font-weight: 500; }
        .alert-item .alert-time { font-size: 11px; color: var(--text-muted); }
        .alerts-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .alerts-filters { display: flex; gap: 8px; }
        .alerts-stats { display: flex; gap: 8px; }
        .alerts-list { display: grid; gap: 16px; }
        .alert-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .alert-card.resolved { opacity: 0.6; }
        .alert-card.critical { border-left: 4px solid var(--danger); }
        .alert-card.warning { border-left: 4px solid var(--warning); }
        .alert-card.info { border-left: 4px solid var(--accent-blue); }
        .alert-card-header { display: flex; justify-content: space-between; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); }
        .alert-severity { display: flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .alert-card-body { padding: 16px; }
        .alert-card-body h4 { margin: 0 0 8px 0; font-size: 14px; }
        .alert-card-body p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .alert-card-footer { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px; border-top: 1px solid var(--border); background: var(--bg-secondary); }
        .resolved-info { flex: 1; font-size: 12px; color: var(--text-muted); }
        .events-list { max-height: 400px; overflow-y: auto; }
        .event-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .event-item:last-child { border-bottom: none; }
        .event-icon { font-size: 18px; }
        .event-info { flex: 1; }
        .event-type { font-size: 13px; font-weight: 500; }
        .event-details { font-size: 11px; color: var(--text-muted); display: flex; gap: 8px; }
        .event-ip { font-family: monospace; }
        .event-time { font-size: 11px; color: var(--text-muted); white-space: nowrap; }
        .mini-table { width: 100%; font-size: 12px; }
        .mini-table th, .mini-table td { padding: 8px; text-align: left; }
        .mini-table th { color: var(--text-muted); font-weight: 500; }
        .ip-rules-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .ip-rules-info p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .ip-rules-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 24px; }
        @media (max-width: 768px) { .ip-rules-grid { grid-template-columns: 1fr; } }
        .ip-rules-panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .ip-rules-panel.whitelist { border-top: 3px solid var(--success); }
        .ip-rules-panel.blacklist { border-top: 3px solid var(--danger); }
        .ip-rules-panel .panel-header { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .ip-rules-panel .panel-header h3 { margin: 0; font-size: 14px; }
        .ip-rules-panel .panel-content { padding: 16px 20px; max-height: 300px; overflow-y: auto; }
        .ip-list { display: flex; flex-direction: column; gap: 8px; }
        .ip-rule-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: var(--bg-secondary); border-radius: 8px; }
        .ip-rule-info { display: flex; flex-direction: column; gap: 2px; }
        .ip-address { font-family: monospace; font-size: 14px; color: var(--text-primary); }
        .ip-description { font-size: 12px; color: var(--text-secondary); }
        .ip-meta { font-size: 11px; color: var(--text-muted); }
        .ip-rules-summary { display: flex; gap: 20px; }
        .ip-rule-stat { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .ip-test-section { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; }
        .ip-test-section h4 { margin: 0 0 16px 0; font-size: 14px; }
        .ip-test-form { display: flex; gap: 8px; margin-bottom: 12px; }
        .ip-test-form .form-input { max-width: 250px; }
        .ip-test-result { display: flex; align-items: center; gap: 8px; padding: 12px; border-radius: 8px; font-size: 13px; }
        .ip-test-result.allowed { background: rgba(34, 197, 94, 0.1); color: var(--success); }
        .ip-test-result.blocked { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .ip-test-reason { color: var(--text-secondary); margin-left: auto; }
        .backups-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 16px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; }
        .backups-info p { margin: 0; font-size: 13px; color: var(--text-secondary); }
        .backup-status { display: flex; justify-content: space-between; align-items: center; }
        .backup-name { font-family: monospace; font-size: 12px; color: var(--text-primary); }
        .backup-meta { font-size: 11px; color: var(--text-muted); }
        .audit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .audit-filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .audit-filters .form-input, .audit-filters .form-select { max-width: 150px; }
        .audit-table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .action-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500; }
        .action-badge.create { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .action-badge.update { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .action-badge.delete { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .entity-type { text-transform: capitalize; }
        .entity-id { display: block; font-size: 10px; color: var(--text-muted); }
        .events-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .events-stats-mini { display: flex; gap: 20px; }
        .stat-mini { display: flex; align-items: baseline; gap: 6px; }
        .stat-mini-value { font-size: 24px; font-weight: 700; }
        .stat-mini-label { font-size: 12px; color: var(--text-muted); }
        .events-filters { display: flex; gap: 8px; }
        .events-table-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .event-type-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 4px; font-size: 11px; background: var(--bg-secondary); }
        .event-type-badge.danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .event-type-badge.success { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .event-details-cell { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; color: var(--text-muted); }
        .pagination { display: flex; justify-content: center; padding: 16px; font-size: 13px; color: var(--text-muted); }
        .login-page { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-primary); }
        .login-card { width: 100%; max-width: 400px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 40px; }
        .login-logo { text-align: center; font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .login-subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 32px; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="login-logo">üìù Noteso</div>
            <div class="login-subtitle">Administration</div>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Mot de passe</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 8px;">Se connecter</button>
            </form>
            <div id="twoFactorSection" style="display: none;">
                <div class="form-group" style="margin-top: 20px;">
                    <label class="form-label">Code 2FA</label>
                    <input type="text" class="form-input" id="twoFactorCode" placeholder="000000" maxlength="6" onkeydown="if(event.key==='Enter'){verify2FA();}">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="verify2FA()">V√©rifier</button>
            </div>
        </div>
    </div>
    <div id="app" class="app" style="display: none;">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="sidebar-logo">üìù Noteso</div></div>
            <nav class="nav-links">
                <a href="#" class="nav-link active" onclick="navigateTo('dashboard')"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
                <a href="#" class="nav-link" onclick="navigateTo('users')"><span class="nav-icon">üë•</span><span>Utilisateurs</span></a>
                <a href="#" class="nav-link" onclick="navigateTo('sites')"><span class="nav-icon">üåê</span><span>Sites</span></a>
                <a href="#" class="nav-link" onclick="navigateTo('payments')"><span class="nav-icon">üí≥</span><span>Paiements</span></a>
                <a href="#" class="nav-link" onclick="navigateTo('security')"><span class="nav-icon">üõ°Ô∏è</span><span>S√©curit√©</span></a>
                <a href="#" class="nav-link" onclick="navigateTo('settings')"><span class="nav-icon">‚öôÔ∏è</span><span>Param√®tres</span></a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <div><div class="user-name" id="userName">Admin</div><div class="user-email" id="userEmail">admin@noteso.fr</div></div>
                </div>
                <button class="btn btn-secondary" style="width: 100%; margin-top: 12px;" onclick="logout()">üö™ D√©connexion</button>
            </div>
        </aside>
        <main class="main"><div id="content"><div class="loading-spinner"></div></div></main>
    </div>
<script>
const API_BASE = '/api';
let currentAdmin = null;
let authToken = localStorage.getItem('authToken');
let currentPage = 'dashboard';
let securityTab = 'dashboard';

async function api(endpoint, options = {}) {
    const headers = { 'Content-Type': 'application/json', ...options.headers };
    if (authToken) headers['Authorization'] = `Bearer ${authToken}`;
    const response = await fetch(API_BASE + endpoint, { ...options, headers });
    const data = await response.json();
    if (!response.ok) throw new Error(data.error || 'Erreur API');
    return data;
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    return new Date(dateStr).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
}

function formatTimeAgo(date) {
    const diff = Math.floor((new Date() - new Date(date)) / 1000);
    if (diff < 60) return '√† l\'instant';
    if (diff < 3600) return `il y a ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `il y a ${Math.floor(diff / 3600)}h`;
    if (diff < 604800) return `il y a ${Math.floor(diff / 86400)} jours`;
    return formatDate(date);
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span><span>${escapeHtml(message)}</span>`;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
}

function closeModal(id) { document.getElementById(id)?.remove(); }

async function handleLogin(event) {
    event.preventDefault();
    try {
        const data = await api('/auth/login', { method: 'POST', body: JSON.stringify({ email: document.getElementById('loginEmail').value, password: document.getElementById('loginPassword').value }) });
        if (data.requires_2fa) {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('twoFactorSection').style.display = 'block';
            window.tempToken = data.temp_token;
            document.getElementById('twoFactorCode').focus();
        } else { completeLogin(data); }
    } catch (err) { showToast(err.message, 'error'); }
}

async function verify2FA() {
    try {
        const data = await api('/auth/verify-2fa', { method: 'POST', body: JSON.stringify({ temp_token: window.tempToken, code: document.getElementById('twoFactorCode').value }) });
        completeLogin(data);
    } catch (err) { showToast(err.message, 'error'); }
}

function completeLogin(data) {
    authToken = data.token; currentAdmin = data.admin;
    localStorage.setItem('authToken', authToken);
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    document.getElementById('userName').textContent = currentAdmin.name || 'Admin';
    document.getElementById('userEmail').textContent = currentAdmin.email;
    document.getElementById('userAvatar').textContent = (currentAdmin.name || 'A')[0].toUpperCase();
    navigateTo('dashboard');
}

function logout() {
    authToken = null; currentAdmin = null;
    localStorage.removeItem('authToken');
    document.getElementById('app').style.display = 'none';
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('twoFactorSection').style.display = 'none';
    document.getElementById('loginEmail').value = '';
    document.getElementById('loginPassword').value = '';
}

async function checkAuth() {
    if (!authToken) return false;
    try { currentAdmin = (await api('/auth/me')).admin; return true; }
    catch { logout(); return false; }
}

function navigateTo(page) {
    currentPage = page;
    document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.getAttribute('onclick')?.includes(`'${page}'`)) link.classList.add('active');
    });
    switch(page) {
        case 'dashboard': loadDashboard(); break;
        case 'users': loadUsersPage(); break;
        case 'sites': loadSitesPage(); break;
        case 'payments': loadPaymentsPage(); break;
        case 'security': loadSecurityPage(); break;
        case 'settings': loadSettingsPage(); break;
        default: loadDashboard();
    }
}

async function loadDashboard() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading-spinner"></div>';
    try {
        const stats = await api('/stats/overview');
        content.innerHTML = `
            <div class="page-header"><div><h1 class="page-title">üìä Dashboard</h1><p class="page-subtitle">Vue d'ensemble</p></div></div>
            <div class="security-stats">
                <div class="stat-card"><div class="stat-icon">üë•</div><div class="stat-info"><div class="stat-value">${stats.users || 0}</div><div class="stat-label">Utilisateurs</div></div></div>
                <div class="stat-card"><div class="stat-icon">üåê</div><div class="stat-info"><div class="stat-value">${stats.sites || 0}</div><div class="stat-label">Sites</div></div></div>
                <div class="stat-card"><div class="stat-icon">üìù</div><div class="stat-info"><div class="stat-value">${stats.notes || 0}</div><div class="stat-label">Notes</div></div></div>
                <div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-info"><div class="stat-value">${stats.revenue || '0'}‚Ç¨</div><div class="stat-label">Revenus</div></div></div>
            </div>`;
    } catch (err) { content.innerHTML = `<div class="empty-state"><p>Erreur: ${escapeHtml(err.message)}</p></div>`; }
}

async function loadUsersPage() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading-spinner"></div>';
    try {
        const data = await api('/users?limit=50');
        content.innerHTML = `<div class="page-header"><div><h1 class="page-title">üë• Utilisateurs</h1><p class="page-subtitle">${data.total || 0} utilisateurs</p></div></div>
        <div class="card"><table class="data-table"><thead><tr><th>Email</th><th>Nom</th><th>Plan</th><th>Cr√©√© le</th></tr></thead><tbody>
        ${(data.users || []).map(u => `<tr><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.name || '-')}</td><td><span class="badge">${u.plan || 'free'}</span></td><td>${formatDate(u.created_at)}</td></tr>`).join('')}
        </tbody></table></div>`;
    } catch (err) { content.innerHTML = `<div class="empty-state"><p>Erreur: ${escapeHtml(err.message)}</p></div>`; }
}

async function loadSitesPage() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading-spinner"></div>';
    try {
        const data = await api('/sites?limit=50');
        content.innerHTML = `<div class="page-header"><div><h1 class="page-title">üåê Sites</h1><p class="page-subtitle">${data.total || 0} sites</p></div></div>
        <div class="card"><table class="data-table"><thead><tr><th>Nom</th><th>Domaine</th><th>Notes</th><th>Cr√©√© le</th></tr></thead><tbody>
        ${(data.sites || []).map(s => `<tr><td>${escapeHtml(s.name)}</td><td><code>${escapeHtml(s.domain || '-')}</code></td><td>${s.notes_count || 0}</td><td>${formatDate(s.created_at)}</td></tr>`).join('')}
        </tbody></table></div>`;
    } catch (err) { content.innerHTML = `<div class="empty-state"><p>Erreur: ${escapeHtml(err.message)}</p></div>`; }
}

async function loadPaymentsPage() {
    const content = document.getElementById('content');
    content.innerHTML = '<div class="loading-spinner"></div>';
    try {
        const data = await api('/payments?limit=50');
        content.innerHTML = `<div class="page-header"><div><h1 class="page-title">üí≥ Paiements</h1><p class="page-subtitle">${data.total || 0} paiements</p></div></div>
        <div class="card"><table class="data-table"><thead><tr><th>Utilisateur</th><th>Montant</th><th>Status</th><th>Date</th></tr></thead><tbody>
        ${(data.payments || []).map(p => `<tr><td>${escapeHtml(p.user_email || '-')}</td><td>${p.amount}‚Ç¨</td><td><span class="badge ${p.status === 'succeeded' ? 'success' : p.status === 'failed' ? 'danger' : ''}">${p.status}</span></td><td>${formatDate(p.created_at)}</td></tr>`).join('')}
        </tbody></table></div>`;
    } catch (err) { content.innerHTML = `<div class="empty-state"><p>Erreur: ${escapeHtml(err.message)}</p></div>`; }
}

async function loadSettingsPage() {
    document.getElementById('content').innerHTML = `<div class="page-header"><div><h1 class="page-title">‚öôÔ∏è Param√®tres</h1><p class="page-subtitle">Configuration</p></div></div><div class="card"><p class="text-muted">Page en d√©veloppement</p></div>`;
}

async function loadSecurityPage() {
    document.getElementById('content').innerHTML = `
        <div class="page-header"><div><h1 class="page-title">üõ°Ô∏è S√©curit√© & Monitoring</h1><p class="page-subtitle">Surveillance, alertes et contr√¥le d'acc√®s</p></div>
        <div class="header-actions"><button class="btn btn-secondary" onclick="createBackup()"><span>üíæ</span> Backup</button><button class="btn btn-primary" onclick="openIPRuleModal()"><span>‚ûï</span> R√®gle IP</button></div></div>
        <div class="security-tabs">
            <button class="security-tab ${securityTab === 'dashboard' ? 'active' : ''}" onclick="switchSecurityTab('dashboard')">üìä Dashboard</button>
            <button class="security-tab ${securityTab === 'alerts' ? 'active' : ''}" onclick="switchSecurityTab('alerts')">üö® Alertes</button>
            <button class="security-tab ${securityTab === 'events' ? 'active' : ''}" onclick="switchSecurityTab('events')">üìã √âv√©nements</button>
            <button class="security-tab ${securityTab === 'audit' ? 'active' : ''}" onclick="switchSecurityTab('audit')">üìù Audit</button>
            <button class="security-tab ${securityTab === 'ip-rules' ? 'active' : ''}" onclick="switchSecurityTab('ip-rules')">üåê IP Rules</button>
            <button class="security-tab ${securityTab === 'backups' ? 'active' : ''}" onclick="switchSecurityTab('backups')">üíæ Backups</button>
        </div>
        <div id="securityContent"><div class="loading-spinner"></div></div>`;
    switchSecurityTab(securityTab);
}

async function switchSecurityTab(tab) {
    securityTab = tab;
    document.querySelectorAll('.security-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.security-tab[onclick="switchSecurityTab('${tab}')"]`)?.classList.add('active');
    const container = document.getElementById('securityContent');
    container.innerHTML = '<div class="loading-spinner"></div>';
    try {
        switch(tab) {
            case 'dashboard': await loadSecurityDashboard(container); break;
            case 'alerts': await loadSecurityAlerts(container); break;
            case 'events': await loadSecurityEvents(container); break;
            case 'audit': await loadAuditLogs(container); break;
            case 'ip-rules': await loadIPRules(container); break;
            case 'backups': await loadBackups(container); break;
        }
    } catch (err) { container.innerHTML = `<div class="empty-state"><p>Erreur: ${escapeHtml(err.message)}</p></div>`; }
}

async function loadSecurityDashboard(container) {
    const data = await api('/security/dashboard');
    container.innerHTML = `
        <div class="security-stats">
            <div class="stat-card ${data.alerts?.criticalCount > 0 ? 'danger' : ''}"><div class="stat-icon">üö®</div><div class="stat-info"><div class="stat-value">${data.alerts?.criticalCount || 0}</div><div class="stat-label">Alertes critiques</div></div></div>
            <div class="stat-card ${data.alerts?.warningCount > 0 ? 'warning' : ''}"><div class="stat-icon">‚ö†Ô∏è</div><div class="stat-info"><div class="stat-value">${data.alerts?.warningCount || 0}</div><div class="stat-label">Avertissements</div></div></div>
            <div class="stat-card"><div class="stat-icon">üîê</div><div class="stat-info"><div class="stat-value">${data.stats24h?.loginAttempts || 0}</div><div class="stat-label">Connexions 24h</div></div></div>
            <div class="stat-card ${(data.stats24h?.loginFailures || 0) > 5 ? 'warning' : ''}"><div class="stat-icon">‚ùå</div><div class="stat-info"><div class="stat-value">${data.stats24h?.loginFailures || 0}</div><div class="stat-label">√âchecs connexion</div></div></div>
            <div class="stat-card"><div class="stat-icon">üåê</div><div class="stat-info"><div class="stat-value">${data.stats24h?.uniqueIPs || 0}</div><div class="stat-label">IPs uniques</div></div></div>
            <div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-info"><div class="stat-value">${data.stats24h?.apiRequests || 0}</div><div class="stat-label">Requ√™tes API</div></div></div>
        </div>
        <div class="security-grid">
            <div class="security-panel"><div class="panel-header"><h3>üö® Alertes actives</h3><a href="#" onclick="switchSecurityTab('alerts'); return false;" class="panel-link">Voir tout ‚Üí</a></div>
            <div class="panel-content">${!data.alerts?.active?.length ? '<div class="empty-state small"><p>‚úÖ Aucune alerte active</p></div>' : data.alerts.active.map(a => `<div class="alert-item ${a.severity}"><div class="alert-icon">${a.severity === 'critical' ? 'üî¥' : a.severity === 'warning' ? 'üü†' : 'üîµ'}</div><div class="alert-info"><div class="alert-title">${escapeHtml(a.title)}</div><div class="alert-time">${formatDate(a.created_at)}</div></div><button class="btn btn-sm" onclick="resolveAlert('${a.id}')">R√©soudre</button></div>`).join('')}</div></div>
            <div class="security-panel"><div class="panel-header"><h3>üïµÔ∏è IPs suspectes</h3></div>
            <div class="panel-content">${!data.suspiciousIPs?.length ? '<div class="empty-state small"><p>‚úÖ Aucune IP suspecte</p></div>' : `<table class="mini-table"><thead><tr><th>IP</th><th>Tentatives</th><th>Action</th></tr></thead><tbody>${data.suspiciousIPs.map(ip => `<tr><td><code>${ip.ip_address}</code></td><td><span class="badge danger">${ip.attempts}</span></td><td><button class="btn btn-sm btn-danger" onclick="blacklistIP('${ip.ip_address}')">Bloquer</button></td></tr>`).join('')}</tbody></table>`}</div></div>
            <div class="security-panel wide"><div class="panel-header"><h3>üìã √âv√©nements r√©cents</h3><a href="#" onclick="switchSecurityTab('events'); return false;" class="panel-link">Voir tout ‚Üí</a></div>
            <div class="panel-content"><div class="events-list">${(data.events || []).map(e => `<div class="event-item"><div class="event-icon">${getEventIcon(e.event_type)}</div><div class="event-info"><div class="event-type">${formatEventType(e.event_type)}</div><div class="event-details">${e.admin_email ? `<span>${e.admin_email}</span>` : ''}<span class="event-ip">${e.ip_address}</span></div></div><div class="event-time">${formatTimeAgo(e.created_at)}</div></div>`).join('')}</div></div></div>
            <div class="security-panel"><div class="panel-header"><h3>üíæ Dernier backup</h3></div><div class="panel-content">${data.lastBackup ? `<div class="backup-status"><div class="backup-info"><div class="backup-name">${data.lastBackup.filename}</div><div class="backup-meta">${formatBytes(data.lastBackup.file_size)} ‚Ä¢ ${formatDate(data.lastBackup.created_at)}</div></div><span class="badge success">OK</span></div>` : `<div class="empty-state small"><p>‚ö†Ô∏è Aucun backup</p><button class="btn btn-primary btn-sm" onclick="createBackup()">Cr√©er maintenant</button></div>`}</div></div>
            <div class="security-panel"><div class="panel-header"><h3>üåê R√®gles IP</h3></div><div class="panel-content"><div class="ip-rules-summary"><div class="ip-rule-stat"><span class="badge success">${data.ipRules?.whitelist || 0}</span><span>Whitelist</span></div><div class="ip-rule-stat"><span class="badge danger">${data.ipRules?.blacklist || 0}</span><span>Blacklist</span></div></div><button class="btn btn-secondary btn-sm" style="width:100%;margin-top:12px" onclick="switchSecurityTab('ip-rules')">G√©rer les r√®gles</button></div></div>
        </div>`;
}

async function loadSecurityAlerts(container) {
    const data = await api('/security/alerts?status=all&limit=100');
    container.innerHTML = `
        <div class="alerts-header"><div class="alerts-filters"><select id="alertStatusFilter" class="form-select"><option value="all">Toutes</option><option value="active" selected>Actives</option><option value="resolved">R√©solues</option></select></div>
        <div class="alerts-stats"><span class="badge danger">${data.counts?.critical || 0} critiques</span><span class="badge warning">${data.counts?.warning || 0} warnings</span><span class="badge success">${data.counts?.resolved || 0} r√©solues</span></div></div>
        <div class="alerts-list">${renderAlertsList(data.alerts || [])}</div>`;
}

function renderAlertsList(alerts) {
    if (!alerts.length) return '<div class="empty-state"><p>Aucune alerte</p></div>';
    return alerts.map(a => `<div class="alert-card ${a.severity} ${a.is_resolved ? 'resolved' : ''}"><div class="alert-card-header"><div class="alert-severity">${a.severity === 'critical' ? 'üî¥' : a.severity === 'warning' ? 'üü†' : 'üîµ'}<span>${a.severity.toUpperCase()}</span></div><div class="alert-time">${formatDate(a.created_at)}</div></div><div class="alert-card-body"><h4>${escapeHtml(a.title)}</h4>${a.message ? `<p>${escapeHtml(a.message)}</p>` : ''}</div><div class="alert-card-footer">${a.is_resolved ? `<span class="resolved-info">R√©solu le ${formatDate(a.resolved_at)}</span><button class="btn btn-sm" onclick="reopenAlert('${a.id}')">R√©ouvrir</button>` : `<button class="btn btn-sm btn-primary" onclick="resolveAlert('${a.id}')">R√©soudre</button>`}<button class="btn btn-sm btn-danger" onclick="deleteAlert('${a.id}')">Supprimer</button></div></div>`).join('');
}

async function resolveAlert(id) { if (!confirm('Marquer comme r√©solue ?')) return; try { await api(`/security/alerts/${id}/resolve`, { method: 'POST' }); showToast('Alerte r√©solue', 'success'); switchSecurityTab('alerts'); } catch (err) { showToast(err.message, 'error'); } }
async function reopenAlert(id) { try { await api(`/security/alerts/${id}/reopen`, { method: 'POST' }); showToast('Alerte r√©ouverte', 'success'); switchSecurityTab('alerts'); } catch (err) { showToast(err.message, 'error'); } }
async function deleteAlert(id) { if (!confirm('Supprimer ?')) return; try { await api(`/security/alerts/${id}`, { method: 'DELETE' }); showToast('Supprim√©e', 'success'); switchSecurityTab('alerts'); } catch (err) { showToast(err.message, 'error'); } }

async function loadSecurityEvents(container) {
    const data = await api('/security/events?limit=100');
    container.innerHTML = `<div class="events-header"><div class="events-stats-mini"><div class="stat-mini"><span class="stat-mini-value">${data.total || 0}</span><span class="stat-mini-label">√©v√©nements</span></div></div></div>
    <div class="events-table-container"><table class="data-table"><thead><tr><th>Type</th><th>Admin</th><th>IP</th><th>D√©tails</th><th>Date</th></tr></thead><tbody>
    ${(data.events || []).map(e => `<tr><td><span class="event-type-badge ${getEventSeverityClass(e.event_type)}">${getEventIcon(e.event_type)} ${formatEventType(e.event_type)}</span></td><td>${e.admin_email || '<span class="text-muted">-</span>'}</td><td><code>${e.ip_address}</code></td><td class="event-details-cell">${formatEventDetails(e.details)}</td><td>${formatDate(e.created_at)}</td></tr>`).join('')}
    </tbody></table></div>`;
}

async function loadAuditLogs(container) {
    const data = await api('/security/audit?limit=50');
    container.innerHTML = `<div class="audit-header"><div class="audit-filters"><select id="auditActionFilter" class="form-select"><option value="">Toutes actions</option><option value="create">Cr√©ation</option><option value="update">Modification</option><option value="delete">Suppression</option><option value="login">Connexion</option></select></div></div>
    <div class="audit-table-container"><table class="data-table"><thead><tr><th>Date</th><th>Admin</th><th>Action</th><th>Entit√©</th><th>IP</th></tr></thead><tbody>
    ${(data.logs || []).map(l => `<tr><td>${formatDate(l.created_at)}</td><td>${l.admin_email || '<span class="text-muted">Syst√®me</span>'}</td><td><span class="action-badge ${l.action}">${formatAction(l.action)}</span></td><td><span class="entity-type">${l.entity_type}</span>${l.entity_id ? `<code class="entity-id">${l.entity_id.substring(0, 15)}...</code>` : ''}</td><td><code>${l.ip_address}</code></td></tr>`).join('')}
    </tbody></table></div><div class="pagination"><span>Page ${data.pagination?.page || 1} / ${data.pagination?.pages || 1}</span></div>`;
}

async function loadIPRules(container) {
    const data = await api('/security/ip-rules');
    const whitelist = (data.rules || []).filter(r => r.type === 'whitelist');
    const blacklist = (data.rules || []).filter(r => r.type === 'blacklist');
    container.innerHTML = `
        <div class="ip-rules-header"><div class="ip-rules-info"><p>üí° Si une whitelist existe, seules ces IPs pourront acc√©der √† l'admin.</p></div><button class="btn btn-primary" onclick="openIPRuleModal()">‚ûï Ajouter</button></div>
        <div class="ip-rules-grid">
            <div class="ip-rules-panel whitelist"><div class="panel-header"><h3>‚úÖ Whitelist (${whitelist.length})</h3></div><div class="panel-content">${!whitelist.length ? '<div class="empty-state small"><p>Aucune IP whitelist√©e</p></div>' : `<div class="ip-list">${whitelist.map(r => renderIPRule(r)).join('')}</div>`}</div></div>
            <div class="ip-rules-panel blacklist"><div class="panel-header"><h3>üö´ Blacklist (${blacklist.length})</h3></div><div class="panel-content">${!blacklist.length ? '<div class="empty-state small"><p>Aucune IP bloqu√©e</p></div>' : `<div class="ip-list">${blacklist.map(r => renderIPRule(r)).join('')}</div>`}</div></div>
        </div>
        <div class="ip-test-section"><h4>üîç Tester une IP</h4><div class="ip-test-form"><input type="text" id="testIPInput" class="form-input" placeholder="192.168.1.1"><button class="btn btn-secondary" onclick="testIPAccess()">V√©rifier</button></div><div id="ipTestResult"></div></div>`;
}

function renderIPRule(rule) {
    return `<div class="ip-rule-item"><div class="ip-rule-info"><code class="ip-address">${rule.ip_address}</code>${rule.description ? `<span class="ip-description">${escapeHtml(rule.description)}</span>` : ''}<span class="ip-meta">Ajout√© ${formatTimeAgo(rule.created_at)}${rule.expires_at ? ` ‚Ä¢ Expire ${formatDate(rule.expires_at)}` : ''}</span></div><button class="btn btn-sm btn-danger" onclick="deleteIPRule('${rule.id}')">üóëÔ∏è</button></div>`;
}

function openIPRuleModal() {
    document.body.insertAdjacentHTML('beforeend', `<div class="modal-overlay" id="ipRuleModal"><div class="modal"><div class="modal-header"><h3>Ajouter une r√®gle IP</h3><button class="modal-close" onclick="closeModal('ipRuleModal')">√ó</button></div><div class="modal-body"><div class="form-group"><label class="form-label">Adresse IP ou CIDR</label><input type="text" class="form-input" id="ipRuleAddress" placeholder="192.168.1.1 ou 192.168.0.0/24"></div><div class="form-group"><label class="form-label">Type</label><select class="form-select" id="ipRuleType"><option value="whitelist">‚úÖ Whitelist</option><option value="blacklist">üö´ Blacklist</option></select></div><div class="form-group"><label class="form-label">Description</label><input type="text" class="form-input" id="ipRuleDescription" placeholder="Bureau, VPN..."></div><div class="form-group"><label class="form-label">Expiration</label><input type="datetime-local" class="form-input" id="ipRuleExpires"></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('ipRuleModal')">Annuler</button><button class="btn btn-primary" onclick="saveIPRule()">Ajouter</button></div></div></div>`);
    document.getElementById('ipRuleAddress').focus();
}

async function saveIPRule() {
    const address = document.getElementById('ipRuleAddress').value.trim();
    if (!address) { showToast('IP requise', 'error'); return; }
    try {
        await api('/security/ip-rules', { method: 'POST', body: JSON.stringify({ ip_address: address, type: document.getElementById('ipRuleType').value, description: document.getElementById('ipRuleDescription').value.trim() || null, expires_at: document.getElementById('ipRuleExpires').value || null }) });
        closeModal('ipRuleModal'); showToast('R√®gle ajout√©e', 'success'); switchSecurityTab('ip-rules');
    } catch (err) { showToast(err.message, 'error'); }
}

async function deleteIPRule(id) { if (!confirm('Supprimer ?')) return; try { await api(`/security/ip-rules/${id}`, { method: 'DELETE' }); showToast('Supprim√©e', 'success'); switchSecurityTab('ip-rules'); } catch (err) { showToast(err.message, 'error'); } }
async function blacklistIP(ip) { if (!confirm(`Bloquer ${ip} ?`)) return; try { await api('/security/ip-rules', { method: 'POST', body: JSON.stringify({ ip_address: ip, type: 'blacklist', description: 'Activit√© suspecte' }) }); showToast('IP bloqu√©e', 'success'); switchSecurityTab('dashboard'); } catch (err) { showToast(err.message, 'error'); } }

async function testIPAccess() {
    const ip = document.getElementById('testIPInput').value.trim();
    if (!ip) { showToast('Entrez une IP', 'error'); return; }
    try {
        const data = await api(`/security/ip-check/${ip}`);
        document.getElementById('ipTestResult').innerHTML = `<div class="ip-test-result ${data.allowed ? 'allowed' : 'blocked'}"><span>${data.allowed ? '‚úÖ' : 'üö´'}</span><span>${data.allowed ? 'Autoris√©e' : 'Bloqu√©e'}</span><span class="ip-test-reason">${data.reason}</span></div>`;
    } catch (err) { document.getElementById('ipTestResult').innerHTML = `<div class="ip-test-result blocked">Erreur: ${escapeHtml(err.message)}</div>`; }
}

async function loadBackups(container) {
    const data = await api('/security/backups');
    container.innerHTML = `<div class="backups-header"><div class="backups-info"><p>üí° T√©l√©chargez vos backups r√©guli√®rement.</p></div><button class="btn btn-primary" onclick="createBackup()">‚ûï Nouveau backup</button></div>
    <div class="backups-list">${!(data.backups || []).length ? '<div class="empty-state"><p>Aucun backup</p><button class="btn btn-primary" onclick="createBackup()">Cr√©er le premier</button></div>' : `<table class="data-table"><thead><tr><th>Fichier</th><th>Taille</th><th>Type</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>${(data.backups || []).map(b => `<tr><td><code>${b.filename}</code></td><td>${formatBytes(b.file_size)}</td><td><span class="badge">${b.type}</span></td><td><span class="badge ${b.status === 'completed' ? 'success' : b.status === 'failed' ? 'danger' : 'warning'}">${b.status}</span></td><td>${formatDate(b.created_at)}</td><td>${b.status === 'completed' ? `<button class="btn btn-sm" onclick="downloadBackup('${b.id}')">üì•</button>` : ''}<button class="btn btn-sm btn-danger" onclick="deleteBackup('${b.id}')">üóëÔ∏è</button></td></tr>`).join('')}</tbody></table>`}</div>`;
}

async function createBackup() { if (!confirm('Cr√©er un backup ?')) return; showToast('Backup en cours...', 'info'); try { const data = await api('/security/backups', { method: 'POST' }); showToast(`Cr√©√©: ${data.filename}`, 'success'); if (securityTab === 'backups') switchSecurityTab('backups'); } catch (err) { showToast('Erreur: ' + err.message, 'error'); } }
function downloadBackup(id) { window.open(`${API_BASE}/security/backups/${id}/download`, '_blank'); }
async function deleteBackup(id) { if (!confirm('Supprimer ?')) return; try { await api(`/security/backups/${id}`, { method: 'DELETE' }); showToast('Supprim√©', 'success'); switchSecurityTab('backups'); } catch (err) { showToast(err.message, 'error'); } }

function getEventIcon(type) { const icons = { 'login_success': '‚úÖ', 'login_failed': '‚ùå', 'logout': 'üëã', '2fa_enabled': 'üîê', '2fa_validation_success': '‚úÖ', '2fa_validation_failed': '‚ùå', 'password_changed': 'üîë', 'backup_created': 'üíæ', 'ip_rule_created': 'üåê', 'suspicious_activity': '‚ö†Ô∏è' }; return icons[type] || 'üìã'; }
function formatEventType(type) { const labels = { 'login_success': 'Connexion r√©ussie', 'login_failed': '√âchec connexion', 'logout': 'D√©connexion', '2fa_enabled': '2FA activ√©', '2fa_validation_success': '2FA valid√©', '2fa_validation_failed': '2FA √©chou√©', 'password_changed': 'Mot de passe chang√©', 'backup_created': 'Backup cr√©√©', 'ip_rule_created': 'R√®gle IP cr√©√©e', 'ip_rule_deleted': 'R√®gle IP supprim√©e', 'suspicious_activity': 'Activit√© suspecte' }; return labels[type] || type.replace(/_/g, ' '); }
function getEventSeverityClass(type) { if (type.includes('failed') || type.includes('suspicious')) return 'danger'; if (type.includes('success') || type.includes('enabled')) return 'success'; return ''; }
function formatEventDetails(details) { if (!details) return '-'; try { const data = typeof details === 'string' ? JSON.parse(details) : details; return data.message || JSON.stringify(data).substring(0, 50) + '...'; } catch { return String(details).substring(0, 50); } }
function formatAction(action) { const labels = { 'create': '‚ûï Cr√©ation', 'update': '‚úèÔ∏è Modification', 'delete': 'üóëÔ∏è Suppression', 'view': 'üëÅÔ∏è Consultation', 'export': 'üì• Export', 'login': 'üîê Connexion', 'resolve': '‚úÖ R√©solution', 'download': 'üì• T√©l√©chargement' }; return labels[action] || action; }

async function init() { if (await checkAuth()) { document.getElementById('loginPage').style.display = 'none'; document.getElementById('app').style.display = 'flex'; document.getElementById('userName').textContent = currentAdmin.name || 'Admin'; document.getElementById('userEmail').textContent = currentAdmin.email; document.getElementById('userAvatar').textContent = (currentAdmin.name || 'A')[0].toUpperCase(); navigateTo('dashboard'); } }
init();
</script>
</body>
</html>
