<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noteso - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    <style>
        html, body, #app { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { font-family: 'Inter', system-ui, sans-serif; }
        .stat-card:hover { transform: translateY(-2px); }
        .spinner { border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="dark bg-dark-950 text-white">

<div id="app" class="h-full">
    <!-- Login Screen -->
    <div id="loginScreen" class="h-full flex items-center justify-center p-4">
        <div class="bg-dark-900 rounded-2xl p-8 w-full max-w-md border border-slate-800">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                <h1 class="text-2xl font-bold">Noteso</h1>
                <p class="text-slate-400 mt-2">Dashboard Multi-Sites</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Email</label>
                    <input type="email" id="loginEmail" required
                           class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="admin@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-2">Mot de passe</label>
                    <input type="password" id="loginPassword" required
                           class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                           placeholder="••••••••">
                </div>
                <div id="totpField" class="hidden">
                    <label class="block text-sm font-medium text-slate-400 mb-2">Code 2FA</label>
                    <input type="text" id="loginTOTP" maxlength="6" pattern="[0-9]{6}"
                           class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center text-2xl tracking-widest"
                           placeholder="000000">
                </div>
                <div id="loginError" class="text-red-400 text-sm hidden"></div>
                <button type="submit" id="loginBtn"
                        class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl font-semibold hover:opacity-90 flex items-center justify-center gap-2">
                    <span>Se connecter</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden h-full">
        <!-- Sidebar -->
        <aside class="fixed left-0 top-0 bottom-0 w-64 bg-dark-900 border-r border-slate-800 z-40 flex flex-col">
            <div class="p-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <span class="font-bold text-xl">Noteso</span>
                </div>
            </div>
            
            <nav class="flex-1 px-4 space-y-1">
                <a href="#" data-page="dashboard" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                    <i class="fas fa-home w-5"></i><span>Dashboard</span>
                </a>
                <a href="#" data-page="sites" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                    <i class="fas fa-globe w-5"></i><span>Sites</span>
                </a>
                <a href="#" data-page="users" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                    <i class="fas fa-users w-5"></i><span>Utilisateurs</span>
                </a>
                <a href="#" data-page="payments" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                    <i class="fas fa-credit-card w-5"></i><span>Paiements</span>
                </a>
                <a href="#" data-page="subscriptions" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                    <i class="fas fa-sync w-5"></i><span>Abonnements</span>
                </a>
                <div class="pt-4 mt-4 border-t border-slate-800">
                    <a href="#" data-page="settings" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-slate-300 hover:bg-dark-800">
                        <i class="fas fa-cog w-5"></i><span>Paramètres</span>
                    </a>
                </div>
            </nav>
            
            <div class="p-4 border-t border-slate-800">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="userName" class="font-medium truncate text-sm">Admin</div>
                        <div id="userEmail" class="text-xs text-slate-400 truncate">admin@example.com</div>
                    </div>
                    <button onclick="logout()" class="p-2 text-slate-400 hover:text-white" title="Déconnexion">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main -->
        <main class="ml-64 h-full flex flex-col">
            <!-- Header -->
            <header class="shrink-0 bg-dark-950 border-b border-slate-800 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 id="pageTitle" class="text-xl font-bold">Dashboard</h1>
                        <p id="pageSubtitle" class="text-slate-400 text-sm">Vue d'ensemble</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <select id="periodSelector" class="px-3 py-2 bg-dark-800 border border-slate-700 rounded-lg text-sm">
                            <option value="7d">7 jours</option>
                            <option value="30d" selected>30 jours</option>
                            <option value="90d">90 jours</option>
                        </select>
                        <button onclick="refreshData()" class="p-2 text-slate-400 hover:text-white">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Content -->
            <div id="pageContent" class="flex-1 overflow-auto p-6">
                
                <!-- Dashboard Page -->
                <div id="page-dashboard" class="page-content h-full flex flex-col gap-6">
                    <!-- Stats -->
                    <div class="shrink-0 grid grid-cols-4 gap-4">
                        <div class="stat-card bg-dark-900 rounded-xl p-4 border border-slate-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="w-10 h-10 bg-green-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-euro-sign text-green-400"></i>
                                </div>
                                <span id="revenueChange" class="text-green-400 text-xs">+0%</span>
                            </div>
                            <div id="revenueValue" class="text-2xl font-bold">0 €</div>
                            <div class="text-slate-400 text-xs">Revenus</div>
                        </div>
                        <div class="stat-card bg-dark-900 rounded-xl p-4 border border-slate-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="w-10 h-10 bg-blue-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-users text-blue-400"></i>
                                </div>
                                <span id="usersChange" class="text-blue-400 text-xs">+0%</span>
                            </div>
                            <div id="usersValue" class="text-2xl font-bold">0</div>
                            <div class="text-slate-400 text-xs">Utilisateurs</div>
                        </div>
                        <div class="stat-card bg-dark-900 rounded-xl p-4 border border-slate-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="w-10 h-10 bg-purple-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-credit-card text-purple-400"></i>
                                </div>
                            </div>
                            <div id="paymentsValue" class="text-2xl font-bold">0</div>
                            <div class="text-slate-400 text-xs">Paiements</div>
                        </div>
                        <div class="stat-card bg-dark-900 rounded-xl p-4 border border-slate-800">
                            <div class="flex items-center justify-between mb-2">
                                <div class="w-10 h-10 bg-amber-500/20 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-sync text-amber-400"></i>
                                </div>
                            </div>
                            <div id="subsValue" class="text-2xl font-bold">0</div>
                            <div class="text-slate-400 text-xs">Abonnements</div>
                            <div id="mrrValue" class="text-slate-500 text-xs">MRR: 0 €</div>
                        </div>
                    </div>
                    
                    <!-- Chart & Activity -->
                    <div class="flex-1 min-h-0 grid grid-cols-3 gap-4">
                        <div class="col-span-2 bg-dark-900 rounded-xl p-4 border border-slate-800 flex flex-col">
                            <h3 class="text-sm font-semibold mb-2 shrink-0">Revenus</h3>
                            <div class="flex-1 min-h-0 relative">
                                <canvas id="revenueChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-dark-900 rounded-xl p-4 border border-slate-800 flex flex-col">
                            <h3 class="text-sm font-semibold mb-2 shrink-0">Activité récente</h3>
                            <div id="activityList" class="flex-1 overflow-auto space-y-2 text-sm">
                                <div class="text-slate-400 text-center py-4">Chargement...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sites Page -->
                <div id="page-sites" class="page-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Mes sites</h2>
                        <button onclick="showAddSiteModal()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg text-sm flex items-center gap-2">
                            <i class="fas fa-plus"></i>Ajouter
                        </button>
                    </div>
                    <div id="sitesList" class="grid grid-cols-3 gap-4">
                        <div class="text-slate-400 text-center py-8">Chargement...</div>
                    </div>
                </div>

                <!-- Users Page -->
                <div id="page-users" class="page-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Utilisateurs</h2>
                        <input type="text" id="userSearch" placeholder="Rechercher..."
                               class="px-4 py-2 bg-dark-800 border border-slate-700 rounded-lg text-sm w-64">
                    </div>
                    <div class="bg-dark-900 rounded-xl border border-slate-800 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-dark-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Utilisateur</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Site</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Date</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr><td colspan="3" class="px-4 py-8 text-center text-slate-400">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Page -->
                <div id="page-payments" class="page-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Paiements</h2>
                        <select id="paymentStatus" class="px-4 py-2 bg-dark-800 border border-slate-700 rounded-lg text-sm">
                            <option value="">Tous</option>
                            <option value="completed">Complétés</option>
                            <option value="pending">En attente</option>
                            <option value="failed">Échoués</option>
                        </select>
                    </div>
                    <div class="bg-dark-900 rounded-xl border border-slate-800 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-dark-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Montant</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Statut</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Site</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Client</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Date</th>
                                </tr>
                            </thead>
                            <tbody id="paymentsTableBody">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Subscriptions Page -->
                <div id="page-subscriptions" class="page-content hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-semibold">Abonnements</h2>
                        <select id="subStatus" class="px-4 py-2 bg-dark-800 border border-slate-700 rounded-lg text-sm">
                            <option value="">Tous</option>
                            <option value="active">Actifs</option>
                            <option value="cancelled">Annulés</option>
                        </select>
                    </div>
                    <div class="bg-dark-900 rounded-xl border border-slate-800 overflow-hidden">
                        <table class="w-full text-sm">
                            <thead class="bg-dark-800">
                                <tr>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Plan</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Montant</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Statut</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Site</th>
                                    <th class="px-4 py-3 text-left text-slate-400 font-medium">Renouvellement</th>
                                </tr>
                            </thead>
                            <tbody id="subsTableBody">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Chargement...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Page -->
                <div id="page-settings" class="page-content hidden">
                    <h2 class="text-lg font-semibold mb-4">Paramètres</h2>
                    <div class="max-w-lg bg-dark-900 rounded-xl p-6 border border-slate-800 space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Thème</label>
                            <select id="settingTheme" class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl">
                                <option value="dark">Sombre</option>
                                <option value="light">Clair</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Devise</label>
                            <select id="settingCurrency" class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl">
                                <option value="EUR">EUR (€)</option>
                                <option value="USD">USD ($)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-slate-400 mb-2">Fuseau horaire</label>
                            <select id="settingTimezone" class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl">
                                <option value="Europe/Paris">Europe/Paris</option>
                                <option value="UTC">UTC</option>
                            </select>
                        </div>
                        <button onclick="saveSettings()" class="w-full py-3 bg-blue-500 hover:bg-blue-600 rounded-xl">
                            Enregistrer
                        </button>
                    </div>
                </div>

            </div>
        </main>
    </div>
</div>

<!-- Modal Add Site -->
<div id="addSiteModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-dark-900 rounded-xl p-6 w-full max-w-md border border-slate-800">
        <h3 class="text-lg font-bold mb-4">Ajouter un site</h3>
        <form id="addSiteForm" class="space-y-4">
            <div>
                <label class="block text-sm text-slate-400 mb-2">Nom</label>
                <input type="text" id="siteName" required class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl">
            </div>
            <div>
                <label class="block text-sm text-slate-400 mb-2">URL</label>
                <input type="url" id="siteUrl" required class="w-full px-4 py-3 bg-dark-800 border border-slate-700 rounded-xl" placeholder="https://">
            </div>
            <div>
                <label class="block text-sm text-slate-400 mb-2">Couleur</label>
                <input type="color" id="siteColor" value="#3b82f6" class="w-full h-12 bg-dark-800 border border-slate-700 rounded-xl cursor-pointer">
            </div>
            <div class="flex gap-3">
                <button type="button" onclick="closeModal('addSiteModal')" class="flex-1 py-3 bg-slate-700 rounded-xl">Annuler</button>
                <button type="submit" class="flex-1 py-3 bg-blue-500 rounded-xl">Créer</button>
            </div>
        </form>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-4 right-4 bg-dark-900 border border-slate-700 rounded-xl p-4 shadow-xl transform translate-y-20 opacity-0 transition-all z-50">
    <div class="flex items-center gap-3">
        <i id="toastIcon" class="fas fa-check-circle text-green-400"></i>
        <span id="toastMessage">Message</span>
    </div>
</div>

<script>
const API_URL = './api.php';
let authToken = localStorage.getItem('noteso_token');
let currentAdmin = null;
let revenueChart = null;
let pendingTOTP = false;

// API
async function api(action, data = {}, method = 'POST') {
    const params = new URLSearchParams({ action, ...data });
    const url = method === 'GET' ? `${API_URL}?${params}` : `${API_URL}?action=${action}`;
    
    const options = {
        method,
        headers: {
            'Content-Type': 'application/json',
            ...(authToken && { 'Authorization': `Bearer ${authToken}` })
        }
    };
    
    if (method !== 'GET') options.body = JSON.stringify(data);
    
    const response = await fetch(url, options);
    const result = await response.json();
    
    if (!response.ok) {
        if (response.status === 401) logout();
        throw new Error(result.error || 'Erreur');
    }
    return result;
}

// Auth
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = document.getElementById('loginBtn');
    const errorDiv = document.getElementById('loginError');
    
    btn.innerHTML = '<div class="spinner"></div>';
    btn.disabled = true;
    errorDiv.classList.add('hidden');
    
    try {
        const loginData = {
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value
        };
        
        const totpCode = document.getElementById('loginTOTP').value;
        if (totpCode) loginData.totp_code = totpCode;
        
        const result = await api('login', loginData);
        
        if (result.requires_2fa) {
            pendingTOTP = true;
            document.getElementById('totpField').classList.remove('hidden');
            document.getElementById('loginTOTP').focus();
            btn.innerHTML = '<span>Vérifier</span>';
            btn.disabled = false;
            return;
        }
        
        authToken = result.token;
        currentAdmin = result.admin;
        localStorage.setItem('noteso_token', authToken);
        pendingTOTP = false;
        document.getElementById('totpField').classList.add('hidden');
        showDashboard();
    } catch (error) {
        errorDiv.textContent = error.message;
        errorDiv.classList.remove('hidden');
        if (pendingTOTP) document.getElementById('loginTOTP').value = '';
    } finally {
        btn.innerHTML = pendingTOTP ? '<span>Vérifier</span>' : '<span>Se connecter</span>';
        btn.disabled = false;
    }
});

function logout() {
    api('logout').catch(() => {});
    authToken = null;
    currentAdmin = null;
    localStorage.removeItem('noteso_token');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('dashboard').classList.add('hidden');
}

async function checkAuth() {
    if (!authToken) return false;
    try {
        currentAdmin = await api('me', {}, 'GET');
        return true;
    } catch { return false; }
}

function showDashboard() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('dashboard').classList.remove('hidden');
    if (currentAdmin) {
        document.getElementById('userName').textContent = `${currentAdmin.firstName} ${currentAdmin.lastName}`;
        document.getElementById('userEmail').textContent = currentAdmin.email;
    }
    navigateTo('dashboard');
}

// Navigation
document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        navigateTo(link.dataset.page);
    });
});

function navigateTo(page) {
    document.querySelectorAll('.nav-link').forEach(l => {
        l.classList.remove('bg-dark-800', 'text-white');
        l.classList.add('text-slate-300');
    });
    document.querySelector(`[data-page="${page}"]`)?.classList.add('bg-dark-800', 'text-white');
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    document.getElementById(`page-${page}`)?.classList.remove('hidden');
    
    const titles = {
        dashboard: ['Dashboard', 'Vue d\'ensemble'],
        sites: ['Sites', 'Gérez vos sites'],
        users: ['Utilisateurs', 'Liste des utilisateurs'],
        payments: ['Paiements', 'Historique'],
        subscriptions: ['Abonnements', 'Abonnements actifs'],
        settings: ['Paramètres', 'Configuration']
    };
    document.getElementById('pageTitle').textContent = titles[page]?.[0] || page;
    document.getElementById('pageSubtitle').textContent = titles[page]?.[1] || '';
    
    loadPageData(page);
}

async function loadPageData(page) {
    switch(page) {
        case 'dashboard': await loadDashboard(); break;
        case 'sites': await loadSites(); break;
        case 'users': await loadUsers(); break;
        case 'payments': await loadPayments(); break;
        case 'subscriptions': await loadSubscriptions(); break;
        case 'settings': await loadSettings(); break;
    }
}

// Dashboard
async function loadDashboard() {
    try {
        const period = document.getElementById('periodSelector').value;
        const data = await api('dashboard', { period }, 'GET');
        
        document.getElementById('revenueValue').textContent = formatCurrency(data.stats.revenue.value);
        document.getElementById('revenueChange').textContent = formatChange(data.stats.revenue.change);
        document.getElementById('revenueChange').className = data.stats.revenue.change >= 0 ? 'text-green-400 text-xs' : 'text-red-400 text-xs';
        
        document.getElementById('usersValue').textContent = formatNumber(data.stats.users.value);
        document.getElementById('usersChange').textContent = formatChange(data.stats.users.change);
        document.getElementById('usersChange').className = data.stats.users.change >= 0 ? 'text-green-400 text-xs' : 'text-red-400 text-xs';
        
        document.getElementById('paymentsValue').textContent = formatNumber(data.stats.payments.value);
        document.getElementById('subsValue').textContent = formatNumber(data.stats.subscriptions.value);
        document.getElementById('mrrValue').textContent = `MRR: ${formatCurrency(data.stats.subscriptions.mrr)}`;
        
        updateChart(data.chart);
        
        const activityList = document.getElementById('activityList');
        if (data.activities.length === 0) {
            activityList.innerHTML = '<div class="text-slate-400 text-center py-4">Aucune activité</div>';
        } else {
            activityList.innerHTML = data.activities.slice(0, 10).map(a => `
                <div class="flex items-center gap-2 p-2 rounded hover:bg-dark-800">
                    <div class="w-6 h-6 rounded flex items-center justify-center text-xs" style="background:${a.siteColor}20;color:${a.siteColor}">
                        <i class="fas fa-${getActivityIcon(a.type)}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="truncate text-xs">${a.description || a.type}</div>
                        <div class="text-xs text-slate-500">${formatDate(a.createdAt)}</div>
                    </div>
                </div>
            `).join('');
        }
    } catch (error) {
        console.error(error);
        showToast(error.message, 'error');
    }
}

function updateChart(chartData) {
    const ctx = document.getElementById('revenueChart');
    if (revenueChart) revenueChart.destroy();
    
    revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.map(d => formatDateShort(d.date)),
            datasets: [{
                label: 'Revenus',
                data: chartData.map(d => d.revenue || 0),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59,130,246,0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } },
                y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } }
            }
        }
    });
}

// Sites
async function loadSites() {
    try {
        const sites = await api('sites', {}, 'GET');
        const container = document.getElementById('sitesList');
        
        if (sites.length === 0) {
            container.innerHTML = '<div class="col-span-3 text-center py-12 text-slate-400">Aucun site</div>';
            return;
        }
        
        container.innerHTML = sites.map(s => `
            <div class="bg-dark-900 rounded-xl p-4 border border-slate-800">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background:${s.color}20">
                        <i class="fas fa-globe" style="color:${s.color}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h3 class="font-medium text-sm truncate">${s.name}</h3>
                        <a href="${s.url}" target="_blank" class="text-xs text-slate-400 truncate block">${s.url}</a>
                    </div>
                </div>
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                    <div><div class="font-bold">${s.userCount}</div><div class="text-slate-500">Users</div></div>
                    <div><div class="font-bold">${s.paymentCount}</div><div class="text-slate-500">Paiements</div></div>
                    <div><div class="font-bold">${formatCurrency(s.totalRevenue)}</div><div class="text-slate-500">Revenus</div></div>
                </div>
            </div>
        `).join('');
    } catch (error) { showToast(error.message, 'error'); }
}

function showAddSiteModal() { document.getElementById('addSiteModal').classList.remove('hidden'); }
function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

document.getElementById('addSiteForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
        await api('sites', {
            name: document.getElementById('siteName').value,
            url: document.getElementById('siteUrl').value,
            color: document.getElementById('siteColor').value
        });
        closeModal('addSiteModal');
        document.getElementById('addSiteForm').reset();
        showToast('Site créé');
        loadSites();
    } catch (error) { showToast(error.message, 'error'); }
});

// Users
async function loadUsers() {
    try {
        const search = document.getElementById('userSearch')?.value || '';
        const data = await api('users', { search }, 'GET');
        const tbody = document.getElementById('usersTableBody');
        
        if (data.users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-8 text-center text-slate-400">Aucun utilisateur</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.users.map(u => `
            <tr class="border-t border-slate-800 hover:bg-dark-800/50">
                <td class="px-4 py-3">
                    <div class="font-medium">${u.name || 'Sans nom'}</div>
                    <div class="text-xs text-slate-400">${u.email || '-'}</div>
                </td>
                <td class="px-4 py-3">
                    <span class="px-2 py-1 rounded text-xs" style="background:${u.siteColor}20;color:${u.siteColor}">${u.siteName}</span>
                </td>
                <td class="px-4 py-3 text-slate-400">${formatDate(u.createdAt)}</td>
            </tr>
        `).join('');
    } catch (error) { showToast(error.message, 'error'); }
}

document.getElementById('userSearch')?.addEventListener('input', debounce(() => loadUsers(), 300));

// Payments
async function loadPayments() {
    try {
        const status = document.getElementById('paymentStatus')?.value || '';
        const data = await api('payments', { status }, 'GET');
        const tbody = document.getElementById('paymentsTableBody');
        
        if (data.payments.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Aucun paiement</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.payments.map(p => `
            <tr class="border-t border-slate-800 hover:bg-dark-800/50">
                <td class="px-4 py-3 font-semibold">${formatCurrency(p.amount)}</td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${getStatusClass(p.status)}">${p.status}</span></td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs" style="background:${p.siteColor}20;color:${p.siteColor}">${p.siteName}</span></td>
                <td class="px-4 py-3 text-slate-400">${p.userEmail || '-'}</td>
                <td class="px-4 py-3 text-slate-400">${formatDate(p.createdAt)}</td>
            </tr>
        `).join('');
    } catch (error) { showToast(error.message, 'error'); }
}

document.getElementById('paymentStatus')?.addEventListener('change', loadPayments);

// Subscriptions
async function loadSubscriptions() {
    try {
        const status = document.getElementById('subStatus')?.value || '';
        const data = await api('subscriptions', { status }, 'GET');
        const tbody = document.getElementById('subsTableBody');
        
        if (data.subscriptions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-slate-400">Aucun abonnement</td></tr>';
            return;
        }
        
        tbody.innerHTML = data.subscriptions.map(s => `
            <tr class="border-t border-slate-800 hover:bg-dark-800/50">
                <td class="px-4 py-3 font-medium">${s.plan}</td>
                <td class="px-4 py-3">${formatCurrency(s.amount)}/${s.billingCycle === 'yearly' ? 'an' : 'mois'}</td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs ${getStatusClass(s.status)}">${s.status}</span></td>
                <td class="px-4 py-3"><span class="px-2 py-1 rounded text-xs" style="background:${s.siteColor}20;color:${s.siteColor}">${s.siteName}</span></td>
                <td class="px-4 py-3 text-slate-400">${s.currentPeriodEnd ? formatDate(s.currentPeriodEnd) : '-'}</td>
            </tr>
        `).join('');
    } catch (error) { showToast(error.message, 'error'); }
}

document.getElementById('subStatus')?.addEventListener('change', loadSubscriptions);

// Settings
async function loadSettings() {
    try {
        const settings = await api('settings', {}, 'GET');
        document.getElementById('settingTheme').value = settings.theme || 'dark';
        document.getElementById('settingCurrency').value = settings.currency || 'EUR';
        document.getElementById('settingTimezone').value = settings.timezone || 'Europe/Paris';
    } catch (error) { console.error(error); }
}

async function saveSettings() {
    try {
        await api('settings', {
            theme: document.getElementById('settingTheme').value,
            currency: document.getElementById('settingCurrency').value,
            timezone: document.getElementById('settingTimezone').value
        }, 'PUT');
        showToast('Enregistré');
    } catch (error) { showToast(error.message, 'error'); }
}

// Helpers
function formatCurrency(amount, currency = 'EUR') {
    return new Intl.NumberFormat('fr-FR', { style: 'currency', currency }).format(amount || 0);
}
function formatNumber(num) { return new Intl.NumberFormat('fr-FR').format(num || 0); }
function formatChange(change) { return `${change >= 0 ? '+' : ''}${change}%`; }
function formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : '-'; }
function formatDateShort(d) { return d ? new Date(d).toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' }) : '-'; }
function getStatusClass(s) {
    const c = { completed: 'bg-green-500/20 text-green-400', active: 'bg-green-500/20 text-green-400', pending: 'bg-yellow-500/20 text-yellow-400', failed: 'bg-red-500/20 text-red-400', cancelled: 'bg-slate-500/20 text-slate-400' };
    return c[s] || 'bg-slate-500/20 text-slate-400';
}
function getActivityIcon(t) {
    const i = { signup: 'user-plus', payment: 'credit-card', login: 'sign-in-alt', subscription: 'sync' };
    return i[t] || 'circle';
}
function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    document.getElementById('toastIcon').className = type === 'success' ? 'fas fa-check-circle text-green-400' : 'fas fa-times-circle text-red-400';
    toast.classList.remove('translate-y-20', 'opacity-0');
    setTimeout(() => toast.classList.add('translate-y-20', 'opacity-0'), 3000);
}
function debounce(fn, wait) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), wait); }; }
function refreshData() { navigateTo(document.querySelector('.nav-link.bg-dark-800')?.dataset.page || 'dashboard'); showToast('Actualisé'); }

document.getElementById('periodSelector').addEventListener('change', () => {
    if (!document.getElementById('page-dashboard').classList.contains('hidden')) loadDashboard();
});

// Init
(async () => { if (await checkAuth()) showDashboard(); })();
</script>

</body>
</html>
